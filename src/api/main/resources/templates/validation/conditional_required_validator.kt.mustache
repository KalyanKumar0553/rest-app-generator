package {{basePkg}}.validation

import jakarta.validation.ConstraintValidator
import jakarta.validation.ConstraintValidatorContext

class ConditionalRequiredValidator : ConstraintValidator<ConditionalRequired, Any> {
    private var field: String = ""
    private var dependsOn: String = ""
    private var equalsVal: String = ""

    override fun initialize(annotation: ConditionalRequired) {
        field = annotation.field
        dependsOn = annotation.dependsOn
        equalsVal = annotation.equals
    }

    override fun isValid(bean: Any?, context: ConstraintValidatorContext): Boolean {
        if (bean == null) return true

        val dep = read(bean, dependsOn)
        val condition = if (equalsVal.isBlank()) dep != null else equalsVal == dep?.toString()
        if (!condition) return true

        val target = read(bean, field) ?: return false
        return if (target is CharSequence) target.toString().trim().isNotEmpty() else true
    }

    private fun read(bean: Any, name: String): Any? = try {
        val f = bean.javaClass.getDeclaredField(name)
        f.isAccessible = true
        f.get(bean)
    } catch (_: Exception) {
        null
    }
}
