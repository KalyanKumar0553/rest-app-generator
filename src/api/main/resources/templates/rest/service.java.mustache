package {{servicePackage}};

import java.util.List;
import java.util.Map;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.server.ResponseStatusException;

{{#idTypeImport}}
import {{idTypeImport}};
{{/idTypeImport}}
import {{modelPackage}}.{{entityName}};
import {{repositoryPackage}}.{{repositoryClass}};
import {{supportPackage}}.{{entitySupportClass}};
{{^noSql}}
import {{supportPackage}}.{{filterSupportClass}};
{{/noSql}}
import {{supportPackage}}.{{querySupportClass}};

@Service
@Transactional(readOnly = true)
public class {{serviceClass}} {

    private final {{repositoryClass}} repository;

    public {{serviceClass}}({{repositoryClass}} repository) {
        this.repository = repository;
    }

{{#createUseService}}
    @Transactional
    public {{createResponseType}} create({{createRequestType}} request) {
        return repository.save(request);
    }
{{/createUseService}}

{{#bulkInsertUseService}}
    @Transactional
    public {{bulkInsertResponseType}} saveAll({{bulkInsertRequestType}} requests) {
        return repository.saveAll(requests);
    }
{{/bulkInsertUseService}}

{{#bulkUpdateUseService}}
    @Transactional
    public {{bulkUpdateResponseType}} bulkUpdate({{bulkUpdateRequestType}} requests) {
        return repository.saveAll(requests);
    }
{{/bulkUpdateUseService}}

{{#updateUseService}}
    @Transactional
    public {{updateResponseType}} update({{idType}} id, {{updateRequestType}} request) {
        {{entityName}} existing = getById(id);
        {{entitySupportClass}}.mergeNonNullFields(request, existing, "{{idName}}");
        return repository.save(existing);
    }
{{/updateUseService}}

{{#patchUseService}}
    @Transactional
    public {{patchResponseType}} patch({{idType}} id, {{patchRequestType}} request) {
        return update(id, request);
    }
{{/patchUseService}}

{{#deleteUseService}}
    @Transactional
    public void deleteById({{idType}} id) {
        if (!repository.existsById(id)) {
            throw new ResponseStatusException(HttpStatus.NOT_FOUND, "{{entityName}} not found for id: " + id);
        }
        repository.deleteById(id);
    }
{{/deleteUseService}}

{{#bulkDeleteUseService}}
    @Transactional
    public void bulkDelete({{bulkDeleteRequestType}} ids) {
        for ({{idType}} id : ids) {
            if (repository.existsById(id)) {
                repository.deleteById(id);
            }
        }
    }
{{/bulkDeleteUseService}}

{{#getUseService}}
    public {{getResponseType}} getById({{idType}} id) {
        return repository.findById(id)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "{{entityName}} not found for id: " + id));
    }
{{/getUseService}}

{{#listUseService}}
    public {{listResponseType}} search(Map<String, String> queryParams, Pageable pageable) {
{{#noSql}}
        return repository.findAll(pageable);
{{/noSql}}
{{^noSql}}
        Map<String, String> filters = {{querySupportClass}}.extractFilterParams(queryParams);
        if (filters.isEmpty()) {
            return repository.findAll(pageable);
        }
        return repository.findAll({{filterSupportClass}}.buildSpecification(filters, {{entityName}}.class), pageable);
{{/noSql}}
    }
{{/listUseService}}
}
