package {{servicePackage}};

import java.util.List;
import java.util.Map;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.server.ResponseStatusException;

{{#idTypeImport}}
import {{idTypeImport}};
{{/idTypeImport}}
import {{modelPackage}}.{{entityName}};
import {{repositoryPackage}}.{{repositoryClass}};
import {{supportPackage}}.{{entitySupportClass}};
import {{supportPackage}}.{{filterSupportClass}};
import {{supportPackage}}.{{querySupportClass}};

@Service
@Transactional(readOnly = true)
public class {{serviceClass}} {

    private final {{repositoryClass}} repository;

    public {{serviceClass}}({{repositoryClass}} repository) {
        this.repository = repository;
    }

    @Transactional
    public {{entityName}} create({{entityName}} request) {
        return repository.save(request);
    }

    @Transactional
    public List<{{entityName}}> saveAll(List<{{entityName}}> requests) {
        return repository.saveAll(requests);
    }

    @Transactional
    public {{entityName}} update({{idType}} id, {{entityName}} request) {
        {{entityName}} existing = getById(id);
        {{entitySupportClass}}.mergeNonNullFields(request, existing, "{{idName}}");
        return repository.save(existing);
    }

    @Transactional
    public void deleteById({{idType}} id) {
        if (!repository.existsById(id)) {
            throw new ResponseStatusException(HttpStatus.NOT_FOUND, "{{entityName}} not found for id: " + id);
        }
        repository.deleteById(id);
    }

    @Transactional
    public void deleteAll() {
        repository.deleteAll();
    }

    public {{entityName}} getById({{idType}} id) {
        return repository.findById(id)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "{{entityName}} not found for id: " + id));
    }

    public Page<{{entityName}}> search(Map<String, String> queryParams, Pageable pageable) {
        Map<String, String> filters = {{querySupportClass}}.extractFilterParams(queryParams);
        if (filters.isEmpty()) {
            return repository.findAll(pageable);
        }
        return repository.findAll({{filterSupportClass}}.buildSpecification(filters, {{entityName}}.class), pageable);
    }
}
