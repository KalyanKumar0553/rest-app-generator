<div class="add-entity-container">
  <div class="entity-form">
    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Name</mat-label>
      <input
        matInput
        [(ngModel)]="entityName"
        (ngModelChange)="onEntityNameChange()"
        placeholder="Entity name"
        required>
      <mat-error *ngIf="nameError">{{ nameError }}</mat-error>
    </mat-form-field>

    <div class="form-group checkbox-row">
      <div class="checkbox-group" *ngIf="isEntityOptionVisible('mappedSuperclass')">
        <mat-checkbox
          [(ngModel)]="mappedSuperclass"
          (change)="onMappedSuperclassChange()"
          color="primary">
          Mapped superclass
        </mat-checkbox>
        <button class="help-btn" type="button" aria-label="Help">
          <i class="bi bi-question-circle"></i>
        </button>
      </div>
      <div class="checkbox-group rest-endpoints-row" *ngIf="isEntityOptionVisible('addRestEndpoints')">
        <mat-checkbox
          [(ngModel)]="addRestEndpoints"
          (change)="onAddRestEndpointsChange()"
          color="primary">
          Add REST endpoints
        </mat-checkbox>
        <button
          *ngIf="addRestEndpoints"
          type="button"
          class="configure-btn"
          (click)="openConfigureRestModal()">
          Configure
        </button>
        <button class="help-btn" type="button" aria-label="Help">
          <i class="bi bi-question-circle"></i>
        </button>
      </div>
      <div class="checkbox-group" *ngIf="isEntityOptionVisible('addCrudOperations')">
        <mat-checkbox
          [(ngModel)]="addCrudOperations"
          (change)="onAddCrudOperationsChange()"
          color="primary">
          Add CRUD operations
        </mat-checkbox>
        <button class="help-btn" type="button" aria-label="Help">
          <i class="bi bi-question-circle"></i>
        </button>
      </div>
    </div>

    <div class="form-group">
      <app-searchable-multi-select
        [label]="'Additional Configuration'"
        [searchPlaceholder]="'Please Enter Text to Search'"
        [options]="additionalConfigurationOptions"
        [selectedValues]="selectedAdditionalConfigurations"
        (selectedValuesChange)="onAdditionalConfigurationsChange($event)"
        [emptyMessage]="'No configuration options found'">
      </app-searchable-multi-select>
    </div>

    <div class="fields-section">
      <div class="fields-header">
        <div class="fields-title">
          <h3 class="section-title">Fields</h3>
          <span class="fields-count">{{ fields.length }}</span>
        </div>
        <button class="add-field-btn" type="button" (click)="addField()" aria-label="Add field">
          <mat-icon>add_circle</mat-icon>
          <span>Add field</span>
        </button>
      </div>

      <div class="fields-panel">
        <app-search-sort
          [searchConfig]="searchConfig"
          [sortOptions]="sortOptions"
          (searchSortChange)="onFieldSearchSortChange($event)"
        >
          <div class="fields-toolbar">
            <div class="fields-meta">
              <span>Showing {{ visibleFields.length }} of {{ fields.length }}</span>
              <span class="filter-hint" *ngIf="hasActiveFilters">Filtered view</span>
            </div>

            <div class="fields-scroll">
              <div class="fields-list" *ngIf="visibleFields.length > 0; else emptyFields">
                <div class="field-accordion" *ngFor="let item of visibleFields">
                  <div class="field-accordion-header">
                    <div class="field-info">
                      <div class="field-name-row">
                        <span class="field-name-text">{{ item.field.name || 'Untitled field' }}</span>
                        <span class="field-type-pill">{{ item.field.type }}</span>
                          <span class="field-badge badge-constraints" *ngIf="getConstraintCount(item.field) > 0">
                            {{ getConstraintLabel(item.field) }}
                          </span>
                      </div>
                      <div class="field-subtext" *ngIf="item.field.type === 'String' && item.field.maxLength">
                        Max length: {{ item.field.maxLength }}
                      </div>
                    </div>
                    <div class="field-actions">
                      <app-help-popover class="field-help-wrap" [ariaLabel]="'Show field details'" placement="top">
                        <div class="field-help-popover-content">
                          <span class="field-type-pill" [title]="item.field.type">{{ item.field.type }}</span>
                          <span
                            class="field-badge badge-constraints"
                            *ngIf="getConstraintCount(item.field) > 0"
                            [title]="getConstraintLabel(item.field)">
                            {{ getConstraintLabel(item.field) }}
                          </span>
                        </div>
                      </app-help-popover>
                      <button
                        class="field-action-btn"
                        type="button"
                        (click)="startEditField(item.index)"
                        aria-label="Edit field">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button
                        class="field-action-btn danger"
                        type="button"
                        [disabled]="item.index === 0"
                        (click)="requestDeleteField(item.index)"
                        aria-label="Delete field">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <ng-template #emptyFields>
                <div class="fields-empty">
                  <div class="empty-icon">
                    <mat-icon>search_off</mat-icon>
                  </div>
                  <p *ngIf="fields.length === 0">No fields yet. Add your first field to get started.</p>
                  <p *ngIf="fields.length > 0">No fields match your search. Try a different keyword.</p>
                </div>
              </ng-template>
            </div>
          </div>
        </app-search-sort>
      </div>
    </div>
  </div>
</div>

  <app-modal
  [isOpen]="isFieldConfigOpen && fieldDraft !== null"
  [title]="fieldConfigMode === 'add' ? 'Add field' : 'Edit field'"
  [size]="'medium'"
  [showFooter]="false"
  (close)="onFieldConfigCancel()">
  <app-field-config
    *ngIf="fieldDraft"
    [field]="fieldDraft"
    [fieldTypes]="fieldTypes"
    [mode]="fieldConfigMode"
    [hasOtherPrimaryKey]="hasOtherPrimaryKey"
    (save)="onFieldConfigSave($event)"
    (cancel)="onFieldConfigCancel()">
  </app-field-config>
</app-modal>

<app-modal
  [isOpen]="isConfigureRestOpen"
  [title]="'Configure API'"
  [size]="'xlarge'"
  (close)="onConfigureRestCancel()">
  <app-rest-config
    #configureRestComponent
    [config]="restConfig"
    [entityFields]="fields"
    [fieldTypeOptions]="fieldTypes"
    [availableModels]="existingEntities"
    [existingRestConfigNames]="existingRestConfigNames"
    [dtoObjects]="dataObjects"
    [enumTypes]="enumTypes"
    [softDeleteEnabled]="softDelete"
    (save)="onConfigureRestSave($event)"
    (cancel)="onConfigureRestCancel()">
  </app-rest-config>
  <div modal-footer>
    <button mat-raised-button type="button" (click)="onConfigureRestCancel()">Cancel</button>
    <button mat-raised-button color="primary" type="button" (click)="saveConfigureRest()">Save</button>
  </div>
</app-modal>

<app-confirmation-modal
  *ngIf="showFieldDeleteModal"
  [title]="fieldDeleteModalConfig.title"
  [message]="fieldDeleteModalConfig.message"
  [buttons]="fieldDeleteModalConfig.buttons"
  (confirm)="confirmDeleteField()"
  (cancel)="cancelDeleteField()">
</app-confirmation-modal>

<app-confirmation-modal
  *ngIf="showDisableRestConfirmation"
  [title]="disableRestModalConfig.title"
  [message]="disableRestModalConfig.message"
  [buttons]="disableRestModalConfig.buttons"
  (confirm)="confirmDisableRestEndpoints()"
  (cancel)="cancelDisableRestEndpoints()">
</app-confirmation-modal>
