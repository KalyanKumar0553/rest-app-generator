<app-confirmation-modal
  *ngIf="showBackConfirmation"
  [title]="backConfirmationConfig.title"
  [message]="backConfirmationConfig.message"
  [buttons]="backConfirmationConfig.buttons"
  (confirm)="confirmBack()"
  (cancel)="cancelBack()"
></app-confirmation-modal>

<app-confirmation-modal
  *ngIf="showRecentProjectPrompt"
  [title]="recentProjectPromptConfig.title"
  [message]="recentProjectPromptConfig.message"
  [buttons]="recentProjectPromptConfig.buttons"
  (confirm)="confirmRecentProjectResume()"
  (cancel)="cancelRecentProjectResume()"
></app-confirmation-modal>

<app-confirmation-modal
  *ngIf="showEntitiesDeleteConfirmation"
  [title]="entitiesDeleteConfirmationConfig.title"
  [message]="entitiesDeleteConfirmationConfig.message"
  [buttons]="entitiesDeleteConfirmationConfig.buttons"
  (confirm)="confirmEntitiesDelete()"
  (cancel)="cancelEntitiesDelete()"
></app-confirmation-modal>

<app-confirmation-modal
  *ngIf="showRestSpecDeleteConfirmation"
  [title]="restSpecDeleteConfirmationConfig.title"
  [message]="restSpecDeleteConfirmationConfig.message"
  [buttons]="restSpecDeleteConfirmationConfig.buttons"
  (confirm)="confirmDeleteControllerRestSpec()"
  (cancel)="cancelDeleteControllerRestSpec()"
></app-confirmation-modal>

<app-confirmation-modal
  *ngIf="showControllersConfigDiscardConfirmation"
  [title]="controllersConfigDiscardConfirmationConfig.title"
  [message]="controllersConfigDiscardConfirmationConfig.message"
  [buttons]="controllersConfigDiscardConfirmationConfig.buttons"
  (confirm)="confirmCancelControllersConfiguration()"
  (cancel)="cancelCancelControllersConfiguration()"
></app-confirmation-modal>

<div class="mobile-header">
  <div class="container">
    <div class="header-content">
      <div class="logo" (click)="handleHome()">
        <span class="logo-icon">&lt;/&gt;</span>
        <span class="logo-text">{{ appSettings.appName }}</span>
      </div>
      <div class="spacer"></div>
      <button class="menu-toggle" (click)="toggleSidebar()" aria-label="Toggle menu">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>
</div>

<div class="sidebar-overlay" [class.show]="isSidebarOpen" (click)="closeSidebar()"></div>

<div class="project-dashboard-container">
  <aside class="sidebar" [class.open]="isSidebarOpen">
    <div class="sidebar-header">
      <div class="logo" (click)="handleHome()">
        <span class="logo-icon">&lt;/&gt;</span>
        <span class="logo-text">{{ appSettings.appName }}</span>
      </div>
    </div>

    <app-sidenav
      [navItems]="visibleNavItems"
      [activeItem]="activeSection"
      (itemClick)="navigateToSection($event)">
    </app-sidenav>
  </aside>

  <main class="main-content">
    <div class="content-body" *ngIf="activeSection === 'general'" id="general">
      <div class="sticky-header">
        <div class="top-actions">
          <button class="back-btn-desktop" (click)="openYamlPreviewModal()" aria-label="Preview YAML spec" mat-stroked-button>
            <i class="bi bi-eye"></i>
          </button>
          <button class="back-btn-desktop" (click)="handleHome()" aria-label="Go to home" mat-stroked-button>
            <i class="bi bi-house-door"></i>
            Home
          </button>
        </div>

        <app-info-banner storageKey="general-info">
          <span>
            Define global project settings. Learn <a href="#" class="info-link" (click)="openInProgress($event)">in the docs</a>.
          </span>
        </app-info-banner>
      </div>

      <div class="scrollable-content">
        <mat-accordion class="expansion-panels">
        <mat-expansion-panel [expanded]="true">
          <mat-expansion-panel-header>
            <mat-panel-title>
              Project settings
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="panel-content">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Project group</mat-label>
              <input
                matInput
                [(ngModel)]="projectSettings.projectGroup"
                (ngModelChange)="onProjectGroupChange()"
                [placeholder]="appSettings.defaultProjectGroup">
              <mat-error *ngIf="projectGroupError">{{ projectGroupError }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Project name</mat-label>
              <input
                matInput
                [(ngModel)]="projectSettings.projectName"
                (ngModelChange)="onProjectNameChange()"
                placeholder="my-app">
              <mat-error *ngIf="projectNameError">{{ projectNameError }}</mat-error>
            </mat-form-field>

            <div class="form-row">
              <label class="field-label">Build type</label>
              <mat-radio-group [(ngModel)]="projectSettings.buildType" class="radio-group-horizontal build-type-group">
                <mat-radio-button value="gradle">Gradle</mat-radio-button>
                <mat-radio-button value="maven">Maven</mat-radio-button>
              </mat-radio-group>
            </div>

            <div class="form-row">
              <label class="field-label">Language</label>
              <mat-radio-group [(ngModel)]="projectSettings.language" class="radio-group-horizontal language-group">
                <mat-radio-button value="java">Java</mat-radio-button>
                <mat-radio-button value="kotlin">Kotlin</mat-radio-button>
              </mat-radio-group>
            </div>

            <!--
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Frontend</mat-label>
              <mat-select [(ngModel)]="projectSettings.frontend">
                <mat-option *ngFor="let option of frontendOptions" [value]="option.toLowerCase()">
                  {{ option }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix matTooltip="Select a frontend framework for your project">info</mat-icon>
            </mat-form-field>
            -->
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              Database settings
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="panel-content">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Database</mat-label>
              <mat-select [(ngModel)]="databaseSettings.database" (ngModelChange)="onDatabaseSelectionChange($event)">
                <mat-option *ngFor="let option of databaseOptions" [value]="option.value">
                  {{ option.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" class="full-width" *ngIf="shouldShowDbGeneration()">
              <mat-label>DB Generation</mat-label>
              <mat-select [(ngModel)]="databaseSettings.dbGeneration">
                <mat-option *ngFor="let option of dbGenerationOptions" [value]="option">
                  {{ option }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <div class="form-row" *ngIf="shouldShowPluralizeTableNames()">
              <mat-checkbox [(ngModel)]="databaseSettings.pluralizeTableNames">
                Pluralize table names
                <mat-icon class="inline-icon" matTooltip="Automatically pluralize table names"
                  (mousedown)="onHelpIconInteraction($event)" (click)="onHelpIconInteraction($event)">info</mat-icon>
              </mat-checkbox>
            </div>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              Developer preferences
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="panel-content">
            <div class="form-row">
              <div class="appl-format-row">
                <label class="field-label">Appl. format</label>
                <button type="button" mat-stroked-button class="profile-add-btn" (click)="onAddProfileClick()">
                  <mat-icon>add</mat-icon>
                  Add profile
                </button>
              </div>
              <div class="appl-format-controls">
                <mat-radio-group [(ngModel)]="developerPreferences.applFormat" class="radio-group-horizontal">
                  <mat-radio-button value="yaml">Yaml</mat-radio-button>
                  <mat-radio-button value="properties">Properties</mat-radio-button>
                </mat-radio-group>
              </div>
            </div>

            <div class="form-row" *ngIf="developerPreferences.profiles.length > 0">
              <label class="field-label">Profiles</label>
              <div class="profile-tags">
                <div class="profile-tag" *ngFor="let profile of developerPreferences.profiles">
                  <span>{{ profile }}</span>
                  <button type="button" class="profile-tag-remove" (click)="removeProfile(profile)" aria-label="Remove profile">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <div class="form-row">
              <label class="field-label">Packages
                <mat-icon class="inline-icon" matTooltip="Package organization structure"
                  (mousedown)="onHelpIconInteraction($event)" (click)="onHelpIconInteraction($event)">info</mat-icon>
              </label>
              <mat-radio-group [(ngModel)]="developerPreferences.packages" class="radio-group-horizontal">
                <mat-radio-button value="technical">Technical</mat-radio-button>
                <mat-radio-button value="domain">Domain driven</mat-radio-button>
              </mat-radio-group>
            </div>

            <div class="form-row">
              <mat-checkbox [(ngModel)]="developerPreferences.enableOpenAPI">
                Enable OpenAPI/Swagger UI
                <mat-icon class="inline-icon" matTooltip="Generate OpenAPI documentation"
                  (mousedown)="onHelpIconInteraction($event)" (click)="onHelpIconInteraction($event)">info</mat-icon>
              </mat-checkbox>
            </div>

            <div class="form-row">
              <mat-checkbox [(ngModel)]="developerPreferences.enableActuator" (ngModelChange)="onEnableActuatorChange($event)">
                Configure Actuator
                <mat-icon class="inline-icon" matTooltip="Include Spring Boot Actuator dependency"
                  (mousedown)="onHelpIconInteraction($event)" (click)="onHelpIconInteraction($event)">info</mat-icon>
              </mat-checkbox>
            </div>

            <div class="form-row">
              <mat-checkbox [(ngModel)]="developerPreferences.configureApi" (ngModelChange)="onEnableConfigureApiChange($event)">
                Enable API Configuration Screen
                <mat-icon class="inline-icon" matTooltip="Enable API controller configuration"
                  (mousedown)="onHelpIconInteraction($event)" (click)="onHelpIconInteraction($event)">info</mat-icon>
              </mat-checkbox>
            </div>

            <div class="form-row">
              <mat-checkbox [(ngModel)]="developerPreferences.useDockerCompose">
                Use Docker compose for development
                <mat-icon class="inline-icon" matTooltip="Include Docker Compose configuration"
                  (mousedown)="onHelpIconInteraction($event)" (click)="onHelpIconInteraction($event)">info</mat-icon>
              </mat-checkbox>
            </div>

            <div class="form-row">
              <label class="field-label">Java version</label>
              <mat-radio-group [(ngModel)]="developerPreferences.javaVersion" class="radio-group-horizontal">
                <mat-radio-button *ngFor="let version of javaVersionOptions" [value]="version">
                  {{ version }}
                </mat-radio-button>
              </mat-radio-group>
            </div>

            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Deployment</mat-label>
              <mat-select [(ngModel)]="developerPreferences.deployment">
                <mat-option *ngFor="let option of deploymentOptions" [value]="option">
                  {{ option }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              Further dependencies
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="panel-content">
            <div class="form-row">
              <label class="field-label">Dependencies
                <mat-icon class="inline-icon" [matTooltip]="appSettings.websiteName + ' already adds required dependencies. Add your custom dependencies here.'"
                  (mousedown)="onHelpIconInteraction($event)" (click)="onHelpIconInteraction($event)">info</mat-icon>
              </label>
            </div>

            <mat-form-field appearance="fill" class="full-width">
              <input
                matInput
                [matAutocomplete]="auto"
                [(ngModel)]="dependencyInput"
                (ngModelChange)="filterDependencies($event)"
                placeholder="Type to search dependencies"
              />
              <mat-icon matSuffix>search</mat-icon>
              <mat-autocomplete #auto="matAutocomplete" (optionSelected)="addDependency($event)">
                <mat-option *ngFor="let dep of filteredDependencies" [value]="dep">
                  {{ dep }}
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>

            <div class="selected-dependencies" *ngIf="selectedDependencies.length > 0">
              <div class="dependency-chip" *ngFor="let dep of selectedDependencies">
                <span>{{ dep }}</span>
                <button type="button" class="remove-chip" (click)="removeDependency(dep)" aria-label="Remove dependency">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
      </div>

      <div class="sticky-footer">
        <div class="action-section">
          <button mat-raised-button color="primary" type="button" (click)="handleGeneralPrimaryAction()" [disabled]="isLoading">
            <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
            <span *ngIf="!isLoading">{{ getGeneralPrimaryActionLabel() }}</span>
            <span *ngIf="isLoading">Loading...</span>
          </button>
        </div>
      </div>
    </div>

    <div class="content-body" *ngIf="activeSection === 'actuator' && developerPreferences.enableActuator" id="actuator">
      <div class="sticky-header">
        <div class="top-actions">
          <button class="back-btn-desktop" (click)="openYamlPreviewModal()" aria-label="Preview YAML spec" mat-stroked-button>
            <i class="bi bi-eye"></i>
          </button>
          <button class="back-btn-desktop" (click)="handleHome()" aria-label="Go to home" mat-stroked-button>
            <i class="bi bi-house-door"></i>
            Home
          </button>
        </div>

        <app-info-banner storageKey="actuator-info">
          <span>
            Configure management endpoints exposed by Spring Boot Actuator for your generated app.
          </span>
        </app-info-banner>
      </div>

      <div class="scrollable-content actuator-scrollable-content">
        <app-actuator-config
          [configurationOptions]="(actuatorConfigurationOptions$ | async) ?? actuatorConfigurationOptions"
          [endpointsByConfiguration]="(actuatorProfileEndpoints$ | async) ?? actuatorProfileEndpoints"
          (endpointsByConfigurationChange)="onActuatorConfigurationsChange($event)">
        </app-actuator-config>
      </div>

      <div class="sticky-footer">
        <div class="action-section">
          <button mat-raised-button color="primary" type="button" (click)="handleGeneralPrimaryAction()" [disabled]="isLoading">
            <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
            <span *ngIf="!isLoading">{{ getGeneralPrimaryActionLabel() }}</span>
            <span *ngIf="isLoading">Loading...</span>
          </button>
        </div>
      </div>
    </div>

    <div class="content-body" *ngIf="activeSection === 'entities'" id="entities">
      <div class="sticky-header">
        <div class="top-actions">
          <button class="back-btn-desktop" (click)="openYamlPreviewModal()" aria-label="Preview YAML spec" mat-stroked-button>
            <i class="bi bi-eye"></i>
          </button>
          <button class="back-btn-desktop" (click)="handleHome()" aria-label="Go to home" mat-stroked-button>
            <i class="bi bi-house-door"></i>
            Home
          </button>
        </div>
      </div>

      <div class="scrollable-content">
        <app-entities
          [entities]="entities"
          [relations]="relations"
          [enums]="enums"
          [dataObjects]="dataObjects"
          (entitiesChange)="onEntitiesChange($event)">
        </app-entities>
      </div>

      <div class="sticky-footer">
        <div class="action-section">
          <button mat-raised-button color="primary" type="button" (click)="setupDataObjects()" [disabled]="isLoading">
            <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
            <span *ngIf="!isLoading">Setup Data Objects</span>
            <span *ngIf="isLoading">Loading...</span>
          </button>
        </div>
      </div>
    </div>

    <div class="content-body" *ngIf="activeSection === 'data-objects'" id="data-objects">
      <div class="sticky-header">
        <div class="top-actions">
          <button class="back-btn-desktop" (click)="openYamlPreviewModal()" aria-label="Preview YAML spec" mat-stroked-button>
            <i class="bi bi-eye"></i>
          </button>
          <button class="back-btn-desktop" (click)="handleHome()" aria-label="Go to home" mat-stroked-button>
            <i class="bi bi-house-door"></i>
            Home
          </button>
        </div>
      </div>

      <div class="scrollable-content">
        <app-data-objects
          [dataObjects]="dataObjects"
          [entities]="entities"
          [enums]="enums"
          (dataObjectsChange)="onDataObjectsChange($event)"
          (entitiesChange)="onEntitiesFromDataObjectsChange($event)"
          (enumsChange)="onEnumsChange($event)">
        </app-data-objects>
      </div>

      <div class="sticky-footer">
        <div class="action-section">
          <button mat-raised-button type="button" (click)="handleDataObjectsPrimaryAction()" [disabled]="isLoading || isGeneratingFromDtoSave">
            {{ getDataObjectsPrimaryActionLabel() }}
          </button>
        </div>
      </div>
    </div>

    <div class="content-body" *ngIf="activeSection === 'controllers' && developerPreferences.configureApi" id="controllers">
      <div class="sticky-header">
        <div class="top-actions">
          <button class="back-btn-desktop" (click)="openYamlPreviewModal()" aria-label="Preview YAML spec" mat-stroked-button>
            <i class="bi bi-eye"></i>
          </button>
          <button class="back-btn-desktop" (click)="handleHome()" aria-label="Go to home" mat-stroked-button>
            <i class="bi bi-house-door"></i>
            Home
          </button>
        </div>

        <app-info-banner storageKey="controllers-info">
          <span>
            Configure API controller behavior for your project.
          </span>
        </app-info-banner>
      </div>

      <div class="scrollable-content">
        <ng-container *ngIf="showControllersConfigEditor; else controllersRestSpecTable">
          <app-rest-config
            #controllersRestConfigComponent
            [config]="isControllersSpecEditMode ? controllersEditingSpecConfig : (isControllersSpecCreateMode ? null : controllersConfig)"
            [entityFields]="controllersEntityFields"
            [fieldTypeOptions]="controllersFieldTypeOptions"
            [availableModels]="entities"
            [existingRestConfigNames]="isControllersSpecEditMode ? controllersEditModeExistingNames : configuredEntityRestSpecNames"
            [dtoObjects]="controllersDtoObjects"
            [enumTypes]="controllersEnumTypes"
            [softDeleteEnabled]="false"
            (save)="onControllersEditorSave($event)"
            (cancel)="onControllersEditorCancel()">
          </app-rest-config>
        </ng-container>

        <ng-template #controllersRestSpecTable>
          <app-controllers-spec-table
            [rows]="controllerRestSpecRows"
            (create)="startNewControllerRestSpec()"
            (edit)="editControllerRestSpec($event)"
            (delete)="requestDeleteControllerRestSpec($event)">
          </app-controllers-spec-table>
        </ng-template>
      </div>

      <div class="sticky-footer">
        <div class="action-section">
          <button
            *ngIf="showControllersConfigEditor; else saveProjectCta"
            mat-raised-button
            type="button"
            (click)="saveControllersConfiguration()"
            [disabled]="isLoading || isGeneratingFromDtoSave">
            Save Configuration
          </button>
          <button
            *ngIf="showControllersConfigEditor"
            mat-raised-button
            class="controllers-cancel-btn"
            type="button"
            (click)="requestCancelControllersConfiguration()"
            [disabled]="isLoading || isGeneratingFromDtoSave">
            Cancel
          </button>
          <ng-template #saveProjectCta>
            <button mat-raised-button type="button" (click)="saveProjectAndInvokeApi()" [disabled]="isLoading || isGeneratingFromDtoSave">
              Save Project
            </button>
          </ng-template>
        </div>
      </div>
    </div>

    <div class="content-body" *ngIf="activeSection === 'explore'" id="explore">
      <div class="sticky-header">
        <div class="top-actions">
          <button class="back-btn-desktop" (click)="openYamlPreviewModal()" aria-label="Preview YAML spec" mat-stroked-button>
            <i class="bi bi-eye"></i>
          </button>
          <button class="back-btn-desktop" (click)="handleHome()" aria-label="Go to home" mat-stroked-button>
            <i class="bi bi-house-door"></i>
            Home
          </button>
        </div>
      </div>

      <div class="scrollable-content explore-content">
        <div class="explore-empty-card" *ngIf="!exploreZipBlob">
          <div class="explore-empty-header">
            <h3>Project Explorer</h3>
            <button
              class="reload-btn"
              type="button"
              (click)="reloadExplore()"
              [disabled]="isExploreSyncing"
              aria-label="Reload project explorer"
              mat-stroked-button>
              <mat-icon [class.spinning]="isExploreSyncing">{{ isExploreSyncing ? 'sync' : 'refresh' }}</mat-icon>
              <span>{{ isExploreSyncing ? 'Syncing...' : 'Reload' }}</span>
            </button>
          </div>
          <p class="explore-empty-body">No synced zip available. Click reload to fetch the latest configured project.</p>
        </div>
        <app-project-view
          *ngIf="exploreZipBlob"
          [isOpen]="activeSection === 'explore'"
          [isSyncing]="isExploreSyncing"
          [zipBlob]="exploreZipBlob"
          [zipFileName]="exploreZipFileName"
          (reload)="reloadExplore()">
        </app-project-view>
      </div>
    </div>
  </main>
</div>

<app-modal
  [isOpen]="showProfileModal"
  [title]="'Add Profiles'"
  [size]="'medium'"
  [showFooter]="false"
  (close)="closeProfileModal()">
  <app-add-profile
    [isOpen]="showProfileModal"
    [profiles]="developerPreferences.profiles"
    (save)="onProfilesSave($event)"
    (cancel)="closeProfileModal()">
  </app-add-profile>
</app-modal>

<app-modal
  [isOpen]="showYamlPreviewModal"
  [title]="'YAML Preview'"
  [size]="'large'"
  [showFooter]="false"
  (close)="closeYamlPreviewModal()">
  <app-project-spec [spec]="yamlPreviewContent"></app-project-spec>
</app-modal>
