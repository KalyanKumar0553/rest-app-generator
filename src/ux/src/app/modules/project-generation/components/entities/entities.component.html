<div class="entities-container">
  <div class="entities-sticky-header">
    <div class="import-section">
      <a href="#" class="import-link" (click)="triggerSchemaImport($event)">Import Schema</a>
      <input
        #schemaFileInput
        class="visually-hidden"
        type="file"
        accept=".json,application/json"
        (change)="onSchemaFileSelected($event)"
      />
    </div>

    <div class="info-banner" *ngIf="showInfoBanner">
      <div class="info-content">
        <p>
          Create your custom database model here. Names are transformed to follow proper naming conventions - please use singular
          table names. Relation types with examples <a href="#" class="info-link">are explained here</a>.
        </p>
      </div>
      <button class="close-banner-btn" (click)="closeInfoBanner()" aria-label="Close banner">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <div class="entities-scrollable">
    <div class="expansion-panel">
    <div class="panel-header" (click)="toggleEntitiesPanel()">
      <div class="panel-title-section">
        <button class="expand-btn" [class.expanded]="entitiesExpanded">
          <i class="bi" [ngClass]="entitiesExpanded ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
        </button>
        <h2 class="panel-title">Entities</h2>
      </div>
      <button class="add-btn" (click)="addEntity(); $event.stopPropagation()" aria-label="Add entity">
        <i class="bi bi-plus-circle"></i>
      </button>
    </div>

    <div class="panel-body" *ngIf="entitiesExpanded">
      <div class="entities-grid" *ngIf="entities.length > 0">
        <div class="entity-box" *ngFor="let entity of entities; let i = index">
          <div class="entity-box-header">
            <h3 class="entity-box-title">{{ entity.name }}</h3>
            <div class="entity-box-actions">
              <button class="entity-action-btn" (click)="editEntity(entity, i)" aria-label="Edit entity">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="entity-action-btn" (click)="deleteEntity(i)" aria-label="Delete entity">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          <div class="entity-box-body">
            <div class="entity-box-fields" *ngIf="entity.fields && entity.fields.length > 0">
              <div class="entity-field-row" *ngFor="let field of entity.fields">
                <span class="entity-field-text">{{ field.name }}: {{ field.type }}<span *ngIf="field.maxLength">({{ field.maxLength }})</span></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="entities.length === 0">
        <p>No entities created yet. Click the + button to add your first entity.</p>
      </div>
    </div>
  </div>

  <div class="expansion-panel">
    <div class="panel-header" (click)="toggleRelationsPanel()">
      <div class="panel-title-section">
        <button class="expand-btn" [class.expanded]="relationsExpanded">
          <i class="bi" [ngClass]="relationsExpanded ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
        </button>
        <h2 class="panel-title">Relations</h2>
      </div>
      <button class="add-btn" (click)="addRelation(); $event.stopPropagation()" aria-label="Add relation">
        <i class="bi bi-plus-circle"></i>
      </button>
    </div>

    <div class="panel-body" *ngIf="relationsExpanded">
      <div class="relations-list" *ngIf="relations.length > 0">
        <div class="relation-card" *ngFor="let relation of relations; let i = index">
          <div class="relation-header">
            <span class="relation-text">{{ relation.sourceEntity }} â†’ {{ relation.targetEntity }}</span>
            <div class="relation-actions">
              <button class="icon-btn" (click)="editRelation(relation, i)" aria-label="Edit relation">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="icon-btn" (click)="deleteRelation(i)" aria-label="Delete relation">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          <div class="relation-details">
            <span class="relation-type-badge">{{ relation.relationType }}</span>
            <span class="relation-field">Field: {{ relation.sourceFieldName }}</span>
            <span class="relation-required" *ngIf="relation.required">Required</span>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="relations.length === 0">
        <p>No relations created yet. Click the + button to add your first relation.</p>
      </div>
    </div>
  </div>
  </div>
</div>

<app-confirmation-modal
  *ngIf="showDeleteConfirmation"
  [title]="deleteModalConfig.title"
  [message]="deleteModalConfig.message"
  [buttons]="deleteModalConfig.buttons"
  (confirm)="confirmDelete()"
  (cancel)="cancelDelete()"
></app-confirmation-modal>

<app-modal
  [isOpen]="showAddEntityModal"
  [title]="editingEntity ? 'Edit entity' : 'Add entity'"
  [size]="'xlarge'"
  (close)="closeModal()">
  <app-add-entity
    [editEntity]="editingEntity"
    [isOpen]="showAddEntityModal"
    [existingEntities]="entities"
    (save)="onEntitySave($event)"
    (cancel)="onEntityCancel()">
  </app-add-entity>
  <div modal-footer>
    <button mat-raised-button type="button" (click)="onEntityCancel()">Cancel</button>
    <button mat-raised-button color="primary" type="button" (click)="saveEntity()">Save</button>
  </div>
</app-modal>

<app-modal
  [isOpen]="showEntityDetailModal"
  [title]="''"
  [size]="'large'"
  (close)="closeEntityDetail()">
  <app-entity-detail-view
    [entity]="viewingEntity"
    (close)="closeEntityDetail()">
  </app-entity-detail-view>
</app-modal>

<app-modal
  [isOpen]="showAddRelationModal"
  [title]="editingRelation ? 'Edit relation' : 'Add relation'"
  [size]="'large'"
  (close)="closeRelationModal()">
  <app-add-relation
    [editRelation]="editingRelation"
    [isOpen]="showAddRelationModal"
    [entities]="entities"
    [existingRelations]="relations"
    (save)="onRelationSave($event)"
    (cancel)="onRelationCancel()">
  </app-add-relation>
  <div modal-footer>
    <button mat-raised-button type="button" (click)="onRelationCancel()">Cancel</button>
    <button mat-raised-button color="primary" type="button" (click)="saveRelation()">Save</button>
  </div>
</app-modal>
