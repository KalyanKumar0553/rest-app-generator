<div class="entities-container">
  <div class="entities-sticky-header">
    <div class="import-section">
      <a href="#" class="import-link" (click)="openImportSchema($event)">Import Schema</a>
      <button class="import-upload-btn" type="button" (click)="triggerSchemaUpload(schemaUploadInput, $event)" aria-label="Upload SQL file">
        <i class="bi bi-upload"></i>
      </button>
      <input
        #schemaUploadInput
        type="file"
        class="schema-upload-input"
        accept=".sql,text/plain"
        (change)="onSchemaFileSelected($event)">
    </div>

    <app-info-banner storageKey="entities-info">
      <span>
        Create your custom database model here. Names are transformed to follow proper naming conventions - please use singular
        table names. Relation types with examples <a href="#" class="info-link">are explained here</a>.
      </span>
    </app-info-banner>
  </div>

  <div class="entities-scrollable">
    <div class="expansion-panel">
    <div class="panel-header" (click)="toggleEntitiesPanel()">
      <div class="panel-title-section">
        <button class="expand-btn" [class.expanded]="entitiesExpanded">
          <i class="bi" [ngClass]="entitiesExpanded ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
        </button>
        <h2 class="panel-title">Entities</h2>
      </div>
      <div class="panel-actions" (click)="$event.stopPropagation()">
        <button
          type="button"
          class="filter-btn"
          [class.active]="showEntityFilters"
          [disabled]="entities.length === 0"
          (click)="toggleEntityFilters()"
          aria-label="Filter entities"
        >
          <i class="bi bi-funnel"></i>
        </button>
        <button type="button" class="add-btn" (click)="addEntity()" aria-label="Add entity">
          <i class="bi bi-plus-circle"></i>
        </button>
      </div>
    </div>

    <div class="panel-body" *ngIf="entitiesExpanded">
      <app-search-sort
        *ngIf="showEntityFilters && entities.length > 0"
        [searchConfig]="searchConfig"
        [sortOptions]="sortOptions"
        (searchSortChange)="onEntitySearchSortChange($event)"
      ></app-search-sort>

      <app-preview-entities
        *ngIf="visibleEntities.length > 0"
        [entities]="visibleEntities"
        [relations]="relations"
        [showActions]="true"
        (viewMore)="openEntityDetailFromMain($event)"
        (editEntity)="editEntityFromList($event)"
        (deleteEntity)="deleteEntityFromList($event)">
      </app-preview-entities>

      <div class="empty-state" *ngIf="entities.length === 0">
        <p>No entities created yet. Click the + button to add your first entity.</p>
      </div>

      <div class="empty-state" *ngIf="entities.length > 0 && visibleEntities.length === 0">
        <p>No entities match your search. Try a different keyword.</p>
      </div>
    </div>
  </div>

  <div class="expansion-panel">
    <div class="panel-header" (click)="toggleRelationsPanel()">
      <div class="panel-title-section">
        <button class="expand-btn" [class.expanded]="relationsExpanded">
          <i class="bi" [ngClass]="relationsExpanded ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
        </button>
        <h2 class="panel-title">Relations</h2>
      </div>
      <div class="panel-actions" (click)="$event.stopPropagation()">
        <button
          *ngIf="relations.length > 0"
          class="graph-link-btn"
          (click)="openRelationsPreview()"
          aria-label="View relations graph">
          View graph
        </button>
        <button class="add-btn" (click)="addRelation()" aria-label="Add relation">
          <i class="bi bi-plus-circle"></i>
        </button>
      </div>
    </div>

    <div class="panel-body relations-panel-body" *ngIf="relationsExpanded">
      <div class="relations-list" *ngIf="relations.length > 0">
        <div class="relation-card" *ngFor="let relation of relations; let i = index">
          <div class="relation-header">
            <span class="relation-text">{{ relation.sourceEntity }} â†’ {{ relation.targetEntity }}</span>
            <div class="relation-actions">
              <button class="icon-btn" (click)="editRelation(relation, i)" aria-label="Edit relation">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="icon-btn danger" (click)="deleteRelation(i)" aria-label="Delete relation">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          <div class="relation-details">
            <span class="relation-type-badge">{{ relation.relationType }}</span>
            <span class="relation-field">Field: {{ relation.sourceFieldName }}</span>
            <span class="relation-required" *ngIf="relation.required">Required</span>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="relations.length === 0">
        <p>No relations created yet. Click the + button to add your first relation.</p>
      </div>
    </div>
  </div>
  </div>
</div>

<app-confirmation-modal
  *ngIf="showDeleteConfirmation"
  [title]="deleteModalConfig.title"
  [message]="deleteModalConfig.message"
  [buttons]="deleteModalConfig.buttons"
  (confirm)="confirmDelete()"
  (cancel)="cancelDelete()"
></app-confirmation-modal>

<app-modal
  [isOpen]="showAddEntityModal"
  [title]="editingEntity ? 'Edit entity' : 'Add entity'"
  [size]="'medium'"
  (close)="closeModal()">
  <app-add-entity
    [editEntity]="editingEntity"
    [isOpen]="showAddEntityModal"
    [existingEntities]="entities"
    (save)="onEntitySave($event)"
    (cancel)="onEntityCancel()">
  </app-add-entity>
  <div modal-footer>
    <button mat-raised-button type="button" (click)="onEntityCancel()">Cancel</button>
    <button mat-raised-button color="primary" type="button" (click)="saveEntity()">Save</button>
  </div>
</app-modal>

<app-modal
  [isOpen]="showEntityDetailModal"
  [title]="''"
  [customHeader]="true"
  [size]="'large'"
  (close)="closeEntityDetail()">
  <div modal-header class="entity-detail-modal-header">
    <div class="entity-detail-header-left">
      <span class="entity-detail-title">{{ viewingEntity?.name }}</span>
      <span class="entity-detail-tag">Entity</span>
      <div class="entity-detail-tags" *ngIf="viewingEntity?.mappedSuperclass || viewingEntity?.addRestEndpoints">
        <span class="entity-detail-meta-tag" *ngIf="viewingEntity?.mappedSuperclass">Mapped Superclass</span>
        <span class="entity-detail-meta-tag" *ngIf="viewingEntity?.addRestEndpoints">REST Endpoints Enabled</span>
      </div>
    </div>
  </div>
  <app-entity-detail-view
    [entity]="viewingEntity"
    [canDeleteFields]="viewingEntitySource === 'main'"
    (deleteField)="deleteEntityField($event)"
    (close)="closeEntityDetail()">
  </app-entity-detail-view>
</app-modal>

<app-modal
  [isOpen]="showAddRelationModal"
  [title]="editingRelation ? 'Edit relation' : 'Add relation'"
  [size]="'large'"
  (close)="closeRelationModal()">
  <app-add-relation
    [editRelation]="editingRelation"
    [isOpen]="showAddRelationModal"
    [entities]="entities"
    [existingRelations]="relations"
    (save)="onRelationSave($event)"
    (cancel)="onRelationCancel()">
  </app-add-relation>
  <div modal-footer>
    <button mat-raised-button type="button" (click)="onRelationCancel()">Cancel</button>
    <button mat-raised-button color="primary" type="button" (click)="saveRelation()">Save</button>
  </div>
</app-modal>

<app-modal
  [isOpen]="showRelationsPreviewModal"
  [title]="'Relations Preview'"
  [size]="'xlarge'"
  [showFooter]="false"
  (close)="closeRelationsPreview()">
  <app-preview-relations [relations]="relations" [isOpen]="showRelationsPreviewModal"></app-preview-relations>
</app-modal>

<app-modal
  [isOpen]="showImportSchemaModal"
  [title]="'Import Schema from SQL'"
  [size]="'xlarge'"
  (close)="closeImportSchema()">
  <app-import-schema [(sqlScript)]="importSchemaSql"></app-import-schema>
  <div modal-footer>
    <button mat-raised-button color="primary" type="button" (click)="goToSchemaPreview()">Go to preview</button>
    <button mat-raised-button type="button" (click)="closeImportSchema()">Cancel</button>
  </div>
</app-modal>

<app-modal
  [isOpen]="showImportSchemaPreviewModal"
  [title]="'Import Schema from SQL'"
  [size]="'xlarge'"
  (close)="closeImportSchemaPreview()">
  <app-import-schema-preview
    [entities]="importPreviewEntities"
    [(addRestEndpoints)]="importAddRestEndpoints"
    (viewEntity)="openEntityDetailFromImport($event)"
    (editEntity)="editImportEntity()"
    (deleteEntity)="requestImportEntityDelete($event)">
  </app-import-schema-preview>
  <div modal-footer>
    <button mat-raised-button color="primary" type="button" (click)="performSchemaImport()">Perform import</button>
    <button mat-raised-button type="button" (click)="goBackToImportSchema()">Go back</button>
  </div>
</app-modal>

<app-confirmation-modal
  *ngIf="showFieldDeleteConfirmation"
  [title]="fieldDeleteModalConfig.title"
  [message]="fieldDeleteModalConfig.message"
  [buttons]="fieldDeleteModalConfig.buttons"
  (confirm)="confirmDeleteField()"
  (cancel)="cancelDeleteField()">
</app-confirmation-modal>

<app-confirmation-modal
  *ngIf="showImportEntityDeleteConfirmation"
  [title]="importEntityDeleteModalConfig.title"
  [message]="importEntityDeleteModalConfig.message"
  [buttons]="importEntityDeleteModalConfig.buttons"
  (confirm)="confirmImportEntityDelete()"
  (cancel)="cancelImportEntityDelete()">
</app-confirmation-modal>
